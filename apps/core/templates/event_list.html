{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load duration_filters %}

{% block title %}
  Events
{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/libs/apex-charts/apex-charts.css' %}" />
  <link rel="stylesheet" href="{% static 'vendor/libs/swiper/swiper.css' %}" />
{% endblock %}

{% block vendor_js %}
  {{ block.super }}
  <script src="{% static 'vendor/libs/apex-charts/apexcharts.js' %}"></script>
  <script src="{% static 'vendor/libs/swiper/swiper.js' %}"></script>
{% endblock %}

{% block page_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'vendor/css/pages/cards-advance.css' %}" />
{% endblock %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/cards-advance.js' %}"></script>
{% endblock %}

{% block content %}

  {% include 'includes/messages.html' %}

  <!-- Filters Dropdown and Search Bar -->
  <div class="row justify-content-start mb-4">
    <div class="col-md-3">
      <div class="dropdown">
        <button class="btn btn-primary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">All Events</button>
        <ul class="dropdown-menu" aria-labelledby="filterDropdown">
          <li>
            <a class="dropdown-item" href="#" onclick="filterEvents('all', 'All Events')">All Events</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" onclick="filterEvents('upcoming', 'Upcoming Events')">Upcoming Events</a>
          </li>
          <li>
            <a class="dropdown-item" href="#" onclick="filterEvents('past', 'Past Events')">Past Events</a>
          </li>
        </ul>
      </div>
    </div>
    <div class="col-md-6">
      <input type="text" id="eventSearch" class="form-control" placeholder="Search events..." />
    </div>
  </div>

  <div class="row">
    <!-- Event Cards -->
    {% for event in events %}
      <div class="col-md-6 col-xxl-4 mb-6 event-card" data-name="{{ event.title }}" data-date="{{ event.start_datetime|date:'Y-m-d' }}">
        <div class="card h-100">
          <div class="card-body d-flex flex-column">
            <div class="bg-label-primary rounded text-center mb-4 pt-4">
              {% if not event.image %}
                <img class="img-fluid" src="{% static 'img/backgrounds/default.jfif' %}" alt="Card girl image" width="140" height="140" style="height: 160px;" />
              {% else %}
                <img class="img-fluid" src="{{ event.image.url }}" alt="Event image" width="140" height="140" style="height: 160px;" />
              {% endif %}
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">{{ event.title }}</h5>
              <span class="badge
                {% if event.status == 'Canceled' %}
                bg-danger
                {% elif event.status == 'Upcoming' %}
                  bg-info
                {% elif event.status == 'Ongoing' %}
                  bg-info
                {% elif event.status == 'Completed' %}
                  bg-success
                {% endif %}">
                {{ event.status }}
              </span>
            </div>

            <!-- Truncated description -->
            <p class="small text-truncate-2 mb-3">{{ event.description }}</p>

            <div class="row mb-4 g-3 mt-auto">
              <div class="col-6">
                <div class="d-flex">
                  <div class="avatar flex-shrink-0 me-3">
                    <span class="avatar-initial rounded bg-label-primary"><i class="ti ti-calendar-event ti-28px"></i></span>
                  </div>
                  <div>
                    <h6 class="mb-0 text-nowrap">{{ event.start_datetime|date:'d M y' }}</h6>
                    <small>Date</small>
                  </div>
                </div>
              </div>
              <div class="col-6">
                <div class="d-flex">
                  <div class="avatar flex-shrink-0 me-3">
                    <span class="avatar-initial rounded bg-label-primary"><i class="ti ti-clock ti-28px"></i></span>
                  </div>
                  <div>
                    <h6 class="mb-0 text-nowrap">{{ event.get_duration|format_duration }}</h6>
                    <small>Duration</small>
                  </div>
                </div>
              </div>
            </div>
            <a href="{% url 'event_details' event.event_id %}" class="btn btn-primary w-100 mt-auto">View the event</a>
          </div>
        </div>
      </div>
    {% endfor %}
    <!-- / Event Cards -->

    <div id="notFoundMessage" class="text-center mt-4" style="display: none;">
      <p>No events found matching your search.</p>
    </div>
  </div>

  <style>
    .card {
      position: relative;
      transition: box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    .card:hover {
      box-shadow: 0 8px 16px rgba(0, 123, 255, 0.4);
    }

    /* Limit the height of the description and add ellipsis */
    .text-truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2; /* Show only 2 lines */
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
    }

    /* Ensure all cards have the same height */
    .event-card .card {
      height: 100%;
    }

    .card-body {
      flex: 1 1 auto;
    }
  </style>

  <script>
    // Function to filter events based on the dropdown selection
    function filterEvents(filterType, buttonText) {
      document.getElementById('filterDropdown').innerHTML = buttonText;

      const eventCards = document.querySelectorAll('.event-card');
      eventCards.forEach(card => {
        const eventDate = new Date(card.getAttribute('data-date'));
        const now = new Date();

        if (filterType === 'upcoming' && eventDate < now) {
          card.style.display = 'none';
        } else if (filterType === 'past' && eventDate >= now) {
          card.style.display = 'none';
        } else {
          card.style.display = 'block';
        }
      });
      document.getElementById('notFoundMessage').style.display = 'none'; // Hide the not found message
    }

    // Function to search for events based on user input
    document.getElementById('eventSearch').addEventListener('input', function () {
      const searchTerm = this.value.toLowerCase();
      const eventCards = document.querySelectorAll('.event-card');
      let found = false;

      eventCards.forEach(card => {
        const eventName = card.getAttribute('data-name').toLowerCase();
        if (eventName.includes(searchTerm)) {
          card.style.display = 'block';
          found = true;
        } else {
          card.style.display = 'none';
        }
      });

      document.getElementById('notFoundMessage').style.display = found ? 'none' : 'block'; // Show or hide not found message
    });
  </script>
{% endblock %}
